<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Music Muse</title>
  <link rel="stylesheet" type="text/css" href="css/musicmuse.css">
  <link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/css/bootstrap.min.css">
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <script src="https://cdn.staticfile.org/jquery/2.1.1/jquery.min.js"></script>
  <script src="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
</head>
<body style="background-color: #a55c1b;
background-image: linear-gradient(315deg,#000000 0%, #a55c1b 74%); width: 100%;
">
<nav class="navbar navbar-inverse" role="navigation">
  <div class="container-fluid"> 
  <div class="navbar-header">
    <a class="navbar-brand" href="#">Music Muse</a>
  </div>
  <form class="navbar-form navbar-left" role="search">
    <div class="form-group">
      <input type="text" class="form-control" placeholder="music title" id="songSearch">
    </div>
    <button type="button" class="btn btn-default" onclick="searchButton()">Search</button>
  </form>
  </div>
</nav>

<div class="root" id="vislization" >

    <svg id = "rootRR" width="1000" height="1000" style="margin-left:100px; margin-right:0px;margin-top: -80px; float: left;"></svg>
</div>


<div width= 100 hight=100 class="panel panel-warning" id="clusterpanel" style="display: none; overflow: scroll; background-color:#FFEFD5;">
  <div class="panel-heading">
    <h3 class="panel-title">Songs in the cluster</h3>
    
  </div>
  
  
  <div class="abc" style="background-color: #FFEFD5;">
    <ul class = "sos" id="SongList" style="padding-left: 0px; padding-top: 0px; padding-left: 0px;">  
    </ul>

    
  </div>
</div>

</body>
</html>


<script>
var cd;
let svg = d3.select("svg");
let margin = {
        left: 100,
        top: 100,
        right: 100,
        bottom: 100
    };

let w = +svg.attr('width') - margin.left - margin.right;
let h = +svg.attr('height') - margin.top - margin.bottom;

var gradient = svg.append("svg:defs")
    .append("svg:linearGradient")
    .attr("id", "gradient")
    .attr("x1", "0%")
    .attr("y1", "0%")
    .attr("x2", "100%")
    .attr("y2", "100%")
    .attr("spreadMethod", "pad");

    gradient.append("svg:stop")
    .attr("offset", "0%")
    .attr("stop-color", "#ffffff")
    .attr("stop-opacity", 1);

    gradient.append("svg:stop")
    .attr("offset", "30%")
    .attr("stop-color", "#000000")
    .attr("stop-opacity", 1);

    

let rootG = svg.append('g').attr('transform',`translate(${+svg.attr("width")/2}, ${+svg.attr("height")/2})`);
const r = h/2;


rootG.append('circle')
        //.transition().duration(8000)
        //.attr("transform", "rotate(360)")
        .attr('id', 'cc1')
        .attr('r',r)
        .style('fill', 'url(#gradient)')
        .style('stroke','black')
        .style('stroke-width',5)
        //.style("stroke-dasharray", ("10,3"));
        .style("stroke")

//var dddd = d3.select("#aaadfdf");
//dddd.each(cycle);

function cycle() {
  d3.select(this).transition()
      .duration(20000)
      .ease(d3.easeLinear)
      .attrTween("transform", function() { return d3.interpolateString("rotate(0)", "rotate(360)"); })
      .on("end", cycle);
}


rootG.append('circle')
        .attr('r',r*0.25)
        .style('fill', 'red')
        //.style('stroke','#D9D9D9')
        //.style("stroke-dasharray", ("20,1"));
        .style('stroke','black')
        .style('stroke-width',5)
        //.style("stroke-dasharray", ("10,3"));
        .style("stroke");
    for (var i =  99; i >= 0; i--) {
      rootG.append('circle')
        .attr('r',r*(i/100))
        .style('fill', 'none')
        .style('stroke','black');
        //.style("stroke-dasharray", ("1,3"));
      
    }

    rootG.append('circle')
        .attr('id','cc2')
        .attr('r',r*0.5)
        .style('fill', 'none')
        .style('stroke','#D9D9D9')
        .style('stroke-width',5)
        .style("stroke-dasharray", ("5,10"));

    rootG.append('circle')
        .attr('id','cc3')
        .attr('r',r*0.75)
        .style('fill', 'none')
        .style('stroke','#D9D9D9')
        .style('stroke-width',2)
        .style("stroke-dasharray", ("15,10"));
    rootG.append("circle")
                .attr('r',10)
                .style('fill','#D9D9D9')
                .style('stroke','#D9D9D9');

var cd2 = d3.select("#cc2");
cd2.each(cycle);

var cd3 = d3.select("#cc3");
cd3.each(cycle);


var blues = d3.scaleOrdinal(d3.schemeReds[9]);
function searchButton(){
  //var l = document.getElementById("rootRR").childNodes;
  //console.info(l);
  typedSong = document.getElementById("songSearch").value;

  //var searchSong = 
  generateVis(typedSong)  
}
function generateVis(songname){
  document.getElementById("clusterpanel").style.display="none";
  
  if (cd == null) {
    //console.info("aaaa")
  }
  else
    d3.select("svg").selectAll(".recc").remove();
    //console.info(cd)


    //console.info(songname.toString());
    //console.info(typeof(songname));
    
    console.info(songname)
    dddd = JSON.stringify(songname);
    console.info(dddd);

    jsonFile = String(songname) + ".json";
    console.info(jsonFile); 
    d3.json(jsonFile)
        .then(data=>{
            //console.log(data);
            const maxR = 50;

            const perAngel = 2*Math.PI / data.length;
            const maxDis = d3.max(data, d=>d.centerDistance);
            const maxSL = d3.max(data, d=>d.songs.length);
            const scale = d3.scaleLinear()
                .domain([0,maxDis])
                .range([0,r - maxR -10]);

            const scaleR = d3.scaleLinear()
                .domain([0,maxSL])
                .range([0,maxR]);

            let global = {selectedIndex: -1};

            /*const scaleC = function(idx){
                const color = d3.interpolateRainbow;
                const scale = d3.scaleLinear().domain([0,data.length]).range([0,1]);
                return color(scale(idx));
            };*/

            data.forEach((d,i)=>{
                const y = scale(d.centerDistance) * Math.sin(i * perAngel);
                const x = scale(d.centerDistance) * Math.cos(i * perAngel);

                const yl = r * Math.sin(i * perAngel);
                const xl = r * Math.cos(i * perAngel);
                /*rootG.append('line')
                    .attr('x1', 0)
                    .attr('y1', 0)
                    .attr('x2', xl)
                    .attr('y2', yl)
                    .style('stroke', '#6495ED')
                    .style('stroke-width',2);*/

                cd = rootG.append('circle')
                    .attr('class', "recc")
                    .attr('cx', 0)
                    .attr('cy', 0)
                    .attr('r',0)
                    .style('fill',blues(i))
                    .style('stroke','#D9D9D9')

                    cd
                    .transition()
                    .duration(1600)
                    .attr("cy", y)
                    .attr("cx", x)
                    .attr('r',scaleR(d.songs.length))
                    

                    cd.on("mouseover",function(){
                      d3.select(this).style('stroke','#86BBD8');
                      d3.select(this).style('stroke-width',10);
                      //d3.select(this).style('fill','orange')
                    });

                    cd.on("mouseout",function(){
                      if (global.selectedIndex === i) {
                        d3.select(this).style('stroke-width',10);
                        d3.select(this).style('stroke', '#D16666');
                        return;
                      }
                      d3.select(this).style('stroke-width',2);
                      d3.select(this).style('stroke', 'rgb(217, 217, 217)');
                      
                      //d3.select(this).style('fill',blues(i))
                      
                    });
                    
                    let k = i;
                    cd.on("click",function(){
                      global.selectedIndex = k;

                      let reccs = document.getElementsByClassName("recc");
                      for (let i = 0; i < reccs.length; i++) {
                        let elem = reccs[i];
                        elem.style.strokeWidth = 2; 
                        elem.style.stroke = 'rgb(217, 217, 217)';
                      }

                      d3.select(this).style('stroke-width',10);
                      d3.select(this).style('stroke', '#D16666');
                      document.getElementById("clusterpanel").style.display="";
                      var s_l = document.getElementById("SongList")
                      var s_l_children = s_l.childNodes;
                      for(var i = s_l_children.length - 1; i >= 0; i--) { 

                      
                        //console.info(i) 
                        s_l.removeChild(s_l_children[i]); 
                        }


                      for (var i = 0; i<d.songs.length;i++) {
                        var s = document.createElement("LI");
                        var s_n = document.createTextNode(d.songs[i]);

                        //var tSong = String(d.songs[i]);
                        s.value = i;
                        
                        var b_n = document.createElement("button");

                        b_n.id = ("bnIncluster");
                        b_n.className = "btn btn-warning";
                        b_n.innerHTML = "Search";
                        var sname = d.songs[i];
                        //b_n.onclick = generateVis(sname);

                        b_n.onclick = function() {
                          console.info(this.previousSibling.nodeValue);

                          //var songInCluster = (this.previousSibling.innerHTML);
                          //console.info(songInCluster);
                          //generateVis(String(this.previousSibling));
                          generateVis(this.previousSibling.nodeValue);
                        }

                        s.appendChild(s_n);
                        s.appendChild(b_n);
                        document.getElementById("SongList").appendChild(s);
                      }

                      
                    });
            });

            /*rootG.append("circle")
                .attr('r',10)
                .style('fill','#D9D9D9')
                .style('stroke','#D9D9D9');*/
        });

}
</script>